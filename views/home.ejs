<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="/stylesheets/styles.css">
    <title>As the Crow Flies</title>
</head>
<body>

  <nav class="navbar bg-body-tertiary navbar-messaging d-flex flex-row justify-content-between">
    <div class="container">
      
        <a class="navbar-brand col-3" href="#">
          <img src="/images/crowb.png" alt="" width="30" height="24" class="d-inline-block align-text-top">
          <h3 class="d-inline-block">As the Crow Flies</h3>
        </a>
        <h3 class="text-center col-3 username-title"><%= username %></h3>
        <div class="col-3">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Menu
            </button>
            <ul class="dropdown-menu dropdown-menu-dark">
              <form action="/home/account" method="post">
                <li><button class="dropdown-item" type="submit">Account</button></li>
              </form>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="../">Logout</a></li>
            </ul>
          </div>
        </div>
    </div>
  </nav>

  <div class="container messaging-content">

    <div class="row justify-content-around">

      <% if(action !== 'login') {%>
      <div class="col-3 friendui roundedCorners">
        <% } else { %>
          <div class="col-3 friendui">
          <% } %>
        <h3 class="text-center">Contacts</h3>
        <div class="overflow-auto friendlist">
        
        <div id="messaginglist" class="d-flex flex-column justify-content-between align-items-center mb-2">
          <div>

          <% if(action == 'login' || action == 'receive'){ %>
                <% if(friendlist.length > 0){
                  friendlist.forEach(function(friend){
                      %>
                      <form action="/home/messages" method="post">
                        <button class="friend d-flex flex-row justify-content-between align-items-center" type="submit" name="userF" value="<%= friend.username %>">
                          <div class="profilepic overflow-hidden"><img src="" alt=""></div>
                          <p><%= friend.username %></p>
                          <span class="badge bg-primary rounded-pill">5</span>
                        </button>
                      </form>
                      <%
                  })
                } else {
                  %>
                  <div>
                      <p>Add some friends!</p>
                  </div>
                  <%
                }
              } %>
              

          </div>
        </div>
      </div>
      
<div class="d-flex flex-row justify-content-center">
  <button id="addFriend" class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#friendSearch" aria-expanded="false" aria-controls="friendSearch">
    +
  </button>
  <button id="notif" class="ms-3 btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#friendReq" aria-expanded="false" aria-controls="friendReq">
    Bell
  </button>
</div>

<div class="collapse" id="friendSearch">
  <div class="card card-body popup-add">
    <div  class="popup-add d-flex flex-column justify-content-between align-items-center text-center">
        <h6>Add Friends by entering their username</h6>
        <form action="/home/search" method="post">
          <div class="form-floating d-flex flex-column justify-content-between align-items-center">
              <input type="username" id="username" class="form-control entry friend-search"
              placeholder="Type username here" name="username" required>
              <label class="labelSearch" for="username">Username</label>
              <button class="searchUser" type="submit">Send Request</button>
          </div>
        </form>
      </div>
  </div>
</div>        
  </div>

      <div id="friendReq" class="card card-body col-3 friend-requests collapse">
        
          <h3 class="text-center">Friend Requests</h3>
          <div>
            <div id="friendReqList" class="d-flex flex-column justify-content-between align-items-center">
              <% if(action == 'login') {
                if (requests.length != 0) { %>
                <% requests.forEach((person) => { %>
                  <div class="requests d-flex flex-row justify-content-between align-items-center">
          
                    <div class="profilepic overflow-hidden ms-2"><img src="" alt=""></div>
                    <p><%= person.username %></p>
                    <div class="d-flex flex-column btn-options">
                      <form action="/home/accept" method="post">
                        <button class="rounded-pill mb-1" type="submit" name="reqID" value="<%= person.FriReqID %>">
                          Accept
                        </button>
                      </form>
                      <form action="/home/decline" method="post">
                        <button class="rounded-pill" type="submit" name="reqID" value="<%= person.FriReqID %>">
                          Delete
                        </button>
                      </form>
                    </div>   
          
                  </div>
              <% })
                } else { %>
                  <div class="d-flex flex-row justify-content-between align-items-center">
                    <p>No Friend Requests</p>
                  </div>
                <% }
              } %>
            </div>
          </div>
       
      </div>

      <% if (action == 'receive') {%> 
      <div class="col-5 messaging">
        <h3 class="text-center">Messaging</h3>
        
        <div class="col-3 friendmessaging friend d-flex align-items-center justify-content-between">
          
              <div class="messager overflow-hidden"><img src="" alt=""></div>
                <span>
                <p><%= userFriend %></p>
                </span>
              </div>
              
        <div class="col-12 messages overflow-auto">
          <ul id="messageLog">
            <% if(action == 'login') {
              console.log("Logged in")
                } else if (action != 'request'){
            if(messages.length > 0) {
                messages.forEach((data) => {
                  if(data.SentToID == id){ %>
                    <li class="d-flex justify-content-start"><div class="fromFriend"><%= data.Message %></div></li>
                  <% } else {%>
                    <li class="d-flex justify-content-end"><div class="toFriend"><%= data.Message %></div></li>
                  <% }
                }) 
              } else {
                %>
                  <li class="text-center">Send a message to get the conversation started!</li>
                <%  
              }
              %>
          </ul>
          <% } %>
        </div>
        <div class="col-12 typing-box">
          <form action="/home/send" method="post">
            <div class="d-flex flex-row">
              <div class="mb-3">
                <textarea class="form-control" id="messageBox" name="message" rows="3"></textarea>
              </div>
              <div class="d-flex flex-row-reverse"><button type="submit">Send</button></div>
            </div>
          </form>
        </div>
        
      </div>
      <% } %> 
    </div>
  </div>

  <footer class="navbar bg-body-tertiary footer-messaging">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/images/crowb.png" alt="" width="30" height="24" class="d-inline-block align-text-top">
        As the Crow Flies
      </a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js" integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
  <script src="/scripts/script.js"></script>
</body>
</html>